<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>E-commerce Support Ticket Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { background: #f7faff; min-height: 100vh; margin:0; font-family:sans-serif; color:#263159;}
    .container { max-width: 900px; margin:48px auto 0; background:#fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(27,52,96,0.15); padding:43px 46px 40px;}
    h1 { text-align:center; font-size:2.3em; letter-spacing:.03em; 
         background:linear-gradient(90deg,#386ef6 35%,#0ebeac 85%); color:transparent;
         background-clip:text; -webkit-background-clip:text; font-weight:800; margin:0 0 30px 0;}
    label { display:block; font-weight:600; margin-top:23px; margin-bottom:7px; color:#284c93;}
    select, textarea, input[type='file'] { width:100%; font-size:1em; padding:13px 14px; border:2px solid #b6d3ff;
      border-radius:8px; background: #fafdff; margin-bottom:5px; box-sizing:border-box; color:#16253b;}
    select:focus, textarea:focus, input[type="file"]:focus { box-shadow:0 0 10px 2px #99cef7; border-color:#386ef6;}
    textarea { min-height: 88px; resize: vertical;}
    button { padding:14px; margin-top:18px; width:100%; background:linear-gradient(90deg,#24c7b6 20%,#386ef6 90%); color:#fff; font-size:1.12em;font-weight:600;border:none; border-radius:8px; cursor:pointer; letter-spacing:.02em; transition:background 0.2s;}
    button:disabled { background:#cadcfc; color: #888; cursor:not-allowed;}
    .mandatory-list { margin:15px 0 0 0; background:#fafdff; border-radius:9px; border:1.5px solid #dbeafc; padding:17px 18px 8px;}
    .field-checkbox { display:flex; align-items:center; margin-bottom:2.5px; cursor:pointer; border-radius:5px; padding-left: 2px;}
    .field-checkbox input[type="checkbox"] { accent-color: #12d8a7; margin-right:11px; width:18px; height:18px;}
    .field-checkbox label { font-weight:500; color: #293368; font-size:1em; margin:0; cursor:pointer;}
    #attachment-section { margin-top:12px; padding:13px 15px 13px 17px; background:linear-gradient(99deg,#e7fffc 60%,#eaf0ff 150%);
      color:#147655; border-radius:7px; border:1.2px solid #51e0ce33; display:none; font-weight:500;}
    .missing { color:#e33e36; font-weight:600;}
    .invalid { background: #fff3f2 !important;}
    .info { background:#eaf2ff; padding:10px 17px; border-radius:7px; margin:12px 0; white-space: pre-line; }
    .mandatory-list h4 { margin:8px 0 6px 0;}
    .error { color:#fb354a; font-weight:bold; margin-top:9px; display:block;}
    .success { color:#22be77; font-weight:bold; margin-top:9px; }
    .critical { border-left:4px solid #ef3030; padding-left:13px; background:#fff6f3;}
  </style>
</head>
<body>
  <div class="container" role="main">
    <h1>E-commerce Support Ticket Portal</h1>

    <label for="app-select">Select Application</label>
    <select id="app-select" aria-describedby="app-desc" aria-required="true">
      <option value="">-- Select an Application --</option>
      <option value="order">Order Booking</option>
      <option value="invoice">Invoice</option>
      <option value="store">Store Management</option>
      <option value="inventory">Inventory</option>
      <option value="delivery">Delivery</option>
      <option value="returns">Returns</option>
      <option value="payment">Payment</option>
      <option value="catalog">Product Catalog</option>
      <option value="support">Customer Support</option>
      <option value="analytics">Analytics</option>
      <option value="loyalty">Loyalty</option>
    </select>

    <div id="app-desc" class="info" style="display:none;"></div>

    <label for="short-desc">Short Description</label>
    <textarea id="short-desc" placeholder="e.g.: Order not showing up, invoice download failed..."></textarea>
    <button type="button" id="btn-suggest">Suggest Mandatory Fields</button>

    <form id="long-form" novalidate autocomplete="off">
      <div id="mandatory-fields" class="mandatory-list" tabindex="0"></div>
      <div id="attachment-section">
        <label><strong>Screenshot / Attachment (optional):</strong></label>
        <input type="file" id="attachment-upload" multiple accept="image/*,.pdf,.doc,.docx,.txt" />
      </div>
      <label for="expanded-description">Detailed Description (optional)</label>
      <textarea id="expanded-description" placeholder="Add details as you wish..."></textarea>
      <button type="submit" id="submit-btn">Submit Ticket</button>
      <span id="form-status"></span>
    </form>
  </div>

<script>
  const appDescriptions = {
    order: "Order Booking manages the creation, amendment, and tracking of purchase orders or sales. Use this for booking, confirmation, error, or missing order issues.",
    invoice: "Invoice generation, download, bill matching, payment status, and credit note requests. Use for invoice issues, mismatches, failed downloads, etc.",
    store: "Store Management covers store on-boarding, closures, configuration, POS integration, etc.",
    inventory: "Real-time product stock, replenishment, allocation, and inventory sync logic, including API or manual updates.",
    delivery: "Order fulfillment, shipment, tracking, scheduling, and last-mile logistics, for all delivery-related issues.",
    returns: "Workflow for customer/product returns, reverse pickups, refund approvals, etc.",
    payment: "Gateway status, transaction errors, refunds, reconciliation, or failed payment/duplicate charge queries.",
    catalog: "Product catalog maintenance, item creation, category sync, attribute management, and content publishing.",
    support: "Customer queries, complaint escalation, agent assignments, chat/call experience, and support ticketing.",
    analytics: "Data/report download, dashboard loading, metrics discrepancy, API exports, and scheduled reports.",
    loyalty: "Points accrual, redemption, tier status, campaign logic, and rewards fulfillment."
  };

  const baselineFields = {
    order: [
      "User Email", "Order ID", "Account/Customer ID", "Product SKU(s)", "Order Date", "Channel (Web/App/Store)",
      "Booked Quantity", "Order Status", "Payment Mode", "Error Message (if any)", "Business Impact",
      "Assigned Sales Rep", "Attachment / Screenshot"
    ],
    invoice: [
      "User Email", "Invoice Number", "Order ID", "Customer/Account ID", "Billing Date", "Invoice Amount",
      "Invoice Status", "Download/Access Mode", "Payment Reference", "Credit Applied (Y/N)", "Error Message", "Attachment / Screenshot"
    ],
    store: [
      "User Email", "Store ID", "Store Name", "Region/Location", "Request Type (Add/Update/Close)", "POS ID/Integration",
      "Manager Contact", "Effective Date", "Issue Category", "Error Message (if any)", "Attachment / Screenshot"
    ],
    inventory: [
      "User Email", "Product SKU(s)", "Warehouse/Location", "Reported Stock", "Threshold Alert (Y/N)", "Update Mode (API/Manual)",
      "Request Date/Time", "Error Message", "Attachment / Screenshot"
    ],
    delivery: [
      "User Email", "Delivery ID", "Order ID", "Courier Partner", "Pickup/Dropoff Address", "Planned Date",
      "Actual Delivery Date", "Tracking Link/Status", "Delivery Status", "Recipient Contact", "Error Message", "Attachment / Screenshot"
    ],
    returns: [
      "User Email", "Return ID", "Order ID", "Product SKU(s)", "Reason for Return", "Return Type (Pickup/Drop)",
      "Status", "Refund Amount", "Refund Status", "Request Date", "Error Message", "Attachment / Screenshot"
    ],
    payment: [
      "User Email", "Payment ID", "Order ID", "Account ID", "Transaction Amount", "Payment Date","Payment Channel",
      "Gateway Reference", "Transaction Status", "Refund (Y/N)", "Error Message", "Attachment / Screenshot"
    ],
    catalog: [
      "User Email", "Product SKU", "Product Name", "Category", "Attribute(s) in Question", "Batch/Upload Date",
      "Approval Status", "Issue Type", "Error Message", "Attachment / Screenshot"
    ],
    support: [
      "User Email", "Support Ticket ID", "Customer ID", "Contact Channel (Chat/Call/Email)", "Complaint Type",
      "Priority", "Issue Summary", "Agent Name", "Date/Time of Issue", "Resolution Status", "Error Message (if any)", "Attachment / Screenshot"
    ],
    analytics: [
      "User Email", "Report Name/ID", "Dashboard/Page", "Metric(s) in Question", "Frequency (Adhoc/Scheduled)",
      "Report Date/Time", "Download Method (CSV/XLS/API)", "Error Message", "Attachment / Screenshot"
    ],
    loyalty: [
      "User Email", "Loyalty ID", "Customer ID", "Tier Status", "Points Involved", "Campaign/Event Name",
      "Redemption Status", "Requested Reward", "Request Date", "Error Message", "Attachment / Screenshot"
    ]
  };

  const keywordsToFields = {
    order: {
      "customer": ["Account/Customer ID"], "order": ["Order ID", "Order Date", "Order Status"], "sku": ["Product SKU(s)"],
      "product": ["Product SKU(s)"], "web": ["Channel (Web/App/Store)"], "app": ["Channel (Web/App/Store)"], 
      "store": ["Channel (Web/App/Store)"], "quantity": ["Booked Quantity"], "sales": ["Assigned Sales Rep"],
      "payment": ["Payment Mode"], "status": ["Order Status"], "error": ["Error Message (if any)"], "impact": ["Business Impact"]
    },
    invoice: {
      "invoice": ["Invoice Number", "Invoice Amount", "Invoice Status", "Billing Date"], "order": ["Order ID"],
      "customer": ["Customer/Account ID"], "amount": ["Invoice Amount"], "date": ["Billing Date"], "payment": ["Payment Reference"],
      "credit": ["Credit Applied (Y/N)"], "download": ["Download/Access Mode"], "error": ["Error Message"]
    },
    store: {
      "store": ["Store ID", "Store Name"], "region": ["Region/Location"], "location": ["Region/Location"],
      "manager": ["Manager Contact"], "date": ["Effective Date"], "request": ["Request Type (Add/Update/Close)"],
      "pos": ["POS ID/Integration"], "category": ["Issue Category"], "error": ["Error Message (if any)"]
    },
    inventory: {
      "warehouse": ["Warehouse/Location"], "stock": ["Reported Stock"], "sku": ["Product SKU(s)"],
      "product": ["Product SKU(s)"], "api": ["Update Mode (API/Manual)"], "manual": ["Update Mode (API/Manual)"],
      "date": ["Request Date/Time"], "threshold": ["Threshold Alert (Y/N)"], "error": ["Error Message"]
    },
    delivery: {
      "delivery": ["Delivery ID", "Delivery Status"], "order": ["Order ID"], "courier": ["Courier Partner"],
      "pickup": ["Pickup/Dropoff Address"], "dropoff": ["Pickup/Dropoff Address"], "planned": ["Planned Date"],
      "actual": ["Actual Delivery Date"], "tracking": ["Tracking Link/Status"], "recipient": ["Recipient Contact"],
      "status": ["Delivery Status"], "error": ["Error Message"]
    },
    returns: {
      "return": ["Return ID", "Reason for Return", "Return Type (Pickup/Drop)", "Status"], "order": ["Order ID"],
      "sku": ["Product SKU(s)"], "product": ["Product SKU(s)"], "refund": ["Refund Amount", "Refund Status"],
      "date": ["Request Date"], "status": ["Status", "Refund Status"], "error": ["Error Message"]
    },
    payment: {
      "payment": ["Payment ID", "Payment Date", "Payment Channel", "Payment Mode"], "order": ["Order ID"], "account": ["Account ID"],
      "transaction": ["Transaction Amount", "Transaction Status"], "gateway": ["Gateway Reference"],
      "refund": ["Refund (Y/N)"], "status": ["Transaction Status"], "error": ["Error Message"]
    },
    catalog: {
      "sku": ["Product SKU"], "product": ["Product Name"], "category": ["Category"], "attribute": ["Attribute(s) in Question"],
      "date": ["Batch/Upload Date"], "approval": ["Approval Status"], "type": ["Issue Type"], "error": ["Error Message"]
    },
    support: {
      "support": ["Support Ticket ID"], "customer": ["Customer ID"], "channel": ["Contact Channel (Chat/Call/Email)"],
      "type": ["Complaint Type"], "priority": ["Priority"], "summary": ["Issue Summary"], "agent": ["Agent Name"],
      "date": ["Date/Time of Issue"], "resolution": ["Resolution Status"], "error": ["Error Message (if any)"]
    },
    analytics: {
      "report": ["Report Name/ID", "Report Date/Time"], "dashboard": ["Dashboard/Page"], "metric": ["Metric(s) in Question"],
      "frequency": ["Frequency (Adhoc/Scheduled)"], "download": ["Download Method (CSV/XLS/API)"], "date": ["Report Date/Time"], "error": ["Error Message"]
    },
    loyalty: {
      "loyalty": ["Loyalty ID"], "customer": ["Customer ID"], "tier": ["Tier Status"], "points": ["Points Involved"],
      "campaign": ["Campaign/Event Name"], "event": ["Campaign/Event Name"], "status": ["Redemption Status"],
      "reward": ["Requested Reward"], "date": ["Request Date"], "error": ["Error Message"]
    }
  };

  const appSelect = document.getElementById("app-select");
  const appDescDiv = document.getElementById("app-desc");
  const shortDescInput = document.getElementById("short-desc");
  const btnSuggest = document.getElementById("btn-suggest");
  const mandatoryFieldsDiv = document.getElementById("mandatory-fields");
  const expandedDesc = document.getElementById("expanded-description");
  const attachmentSection = document.getElementById("attachment-section");
  const submitBtn = document.getElementById("submit-btn");
  const formStatus = document.getElementById("form-status");

  function normalize(text) {
    return String(text).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  }

  function analyzeDescriptionFields(appKey, description) {
    const baseFields = baselineFields[appKey] || [];
    const keywordMap = keywordsToFields[appKey] || {};
    const descNorm = normalize(description);

    const matchedFields = [];
    baseFields.forEach(field => {
      const keywordsForField = Object.entries(keywordMap)
        .filter(([k, v]) => v.includes(field))
        .map(([k]) => k);
      const isMatched = keywordsForField.some(kw => descNorm.includes(kw));
      if (isMatched) {
        matchedFields.push(field);
      }
    });

    const attachments = baseFields.filter(f => /screenshot|attachment/i.test(f));
    const missingFields = baseFields.filter(f => !matchedFields.includes(f) && !attachments.includes(f));
    return { matchedFields, missingFields, attachments };
  }

  appSelect.addEventListener("change", () => {
    const val = appSelect.value;
    if (val && appDescriptions[val]) {
      appDescDiv.style.display = "block";
      appDescDiv.textContent = appDescriptions[val];
    } else {
      appDescDiv.style.display = "none";
      appDescDiv.textContent = "";
    }
    mandatoryFieldsDiv.innerHTML = "";
    expandedDesc.value = "";
    attachmentSection.style.display = "none";
    formStatus.textContent = "";
  });

  btnSuggest.addEventListener("click", () => {
    mandatoryFieldsDiv.innerHTML = "";
    expandedDesc.value = "";
    attachmentSection.style.display = "none";
    formStatus.textContent = "";

    const app = appSelect.value;
    const desc = shortDescInput.value.trim();

    if (!app) {
      mandatoryFieldsDiv.innerHTML = '<span class="error">Please select an application.</span>';
      return;
    }
    if (!desc) {
      mandatoryFieldsDiv.innerHTML = '<span class="error">Please enter a short description.</span>';
      return;
    }

    const { matchedFields, missingFields, attachments } = analyzeDescriptionFields(app, desc);

    function renderFields(title, fields, preChecked=false) {
      if (!fields.length) return;
      const titleElem = document.createElement("h4");
      titleElem.textContent = title;
      mandatoryFieldsDiv.appendChild(titleElem);
      fields.forEach(field => {
        const fieldId = `cb-${field.replace(/\s+/g, '-').toLowerCase()}`;
        const div = document.createElement("div");
        div.className = "field-checkbox";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = fieldId;
        checkbox.name = "mandatoryField";
        checkbox.value = field;
        if(preChecked) checkbox.checked = true;

        const label = document.createElement("label");
        label.htmlFor = fieldId;
        label.textContent = field;

        div.appendChild(checkbox);
        div.appendChild(label);
        mandatoryFieldsDiv.appendChild(div);

        // Add event listener to sync checked fields with detailed description
        checkbox.addEventListener("change", () => {
          syncDescriptionWithCheckboxes();
        });
      });
    }

    renderFields("Fields Mentioned in Your Description:", matchedFields, true);
    renderFields("Other Recommended Mandatory Fields:", missingFields, false);

    if (attachments.length) attachmentSection.style.display = "block";
    else attachmentSection.style.display = "none";

    // Initialize detailed description with matched fields checked
    syncDescriptionWithCheckboxes();
  });

  // Improved function to sync checkboxes with description preserving user input
  function syncDescriptionWithCheckboxes() {
    let text = expandedDesc.value;

    // Split text into sections by headers ending in ":"
    const sections = [];
    const lines = text.split('\n');
    let currentSection = {header: null, content: []};
    for(let line of lines) {
      if(line.trim().endsWith(':')) {
        if(currentSection.header !== null) {
          sections.push(currentSection);
        }
        currentSection = {header: line.trim().slice(0, -1), content: []};
      } else {
        currentSection.content.push(line);
      }
    }
    if(currentSection.header !== null) {
      sections.push(currentSection);
    }

    const checkedFields = new Set([...document.querySelectorAll('#mandatory-fields input[type="checkbox"]:checked')].map(cb => cb.value));
    // Build new sections: keep only checked fields
    const newSections = [];
    checkedFields.forEach(field => {
      const found = sections.find(s => s.header === field);
      if(found) {
        newSections.push({header: field, content: found.content});
      } else {
        newSections.push({header: field, content: [""]});
      }
    });

    // Rebuild text 
    let newText = "";
    newSections.forEach(section => {
      newText += section.header + ":\n";
      const content = section.content.join('\n').replace(/\s+$/,'');
      newText += content + "\n\n";
    });

    expandedDesc.value = newText.trimEnd();
  }

  document.getElementById("long-form").addEventListener("submit", function(e) {
    e.preventDefault();
    formStatus.textContent = "";
    const checkedFields = Array.from(mandatoryFieldsDiv.querySelectorAll("input[type='checkbox']:checked"))
      .map(cb => cb.value);
    const uncheckedFields = Array.from(mandatoryFieldsDiv.querySelectorAll("input[type='checkbox']"))
      .filter(cb => !cb.checked)
      .map(cb => cb.value);
    let message = "Ticket submitted successfully.\n\n";
    message += "Fields you have acknowledged:\n";
    message += checkedFields.length ? checkedFields.map(f => "- "+f).join("\n") : " None\n";
    message += "\nRecommended but not acknowledged:\n";
    message += uncheckedFields.length ? uncheckedFields.map(f => "- "+f).join("\n") : " None\n";
    formStatus.textContent = message;
    formStatus.className = "info";
  });
</script>
</body>
</html>
